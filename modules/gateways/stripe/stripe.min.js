function initStripe(){var e=jQuery('input[name="paymentmethod"]'),t=jQuery("#frmCheckout"),s=jQuery(".frm-credit-card-input"),i=jQuery("#frmPayment"),n=jQuery("#frmCreditCardDetails");if(e.length&&!s.length){var r=jQuery("#newCardInfo");insertAndMountElementsDivAfterInput(r),elementsDiv=jQuery("#stripeElements");var a=jQuery('input[name="ccinfo"]'),d=jQuery('input[name="ccinfo"]:checked'),o=jQuery('input[name="paymentmethod"]:checked').val(),l=jQuery("#existingCardInfo");"undefined"==typeof o&&(o=jQuery('input[name="paymentmethod"]').val()),enablePaymentRequestButton(),"stripe"===o&&(hide_cc_fields(),enable_stripe(),"new"!==d.val()&&(get_existing_token(d.val()),elementsDiv.hide(),t.off("submit.stripe"),l.hide(),"000"!==amount&&t.on("submit.stripe",processExisting))),e.on("ifChecked",function(){if(o=jQuery(this).val(),"stripe"===o){var e=jQuery('input[name="ccinfo"]:checked').val();hide_cc_fields(),enable_stripe(),"new"!==e&&(get_existing_token(e),elementsDiv.hide(),t.off("submit.stripe"),"000"!==amount&&t.on("submit.stripe",processExisting))}else disable_stripe()}),a.on("ifChecked",function(){t.off("submit.stripe"),o=jQuery('input[name="paymentmethod"]:checked').val(),"stripe"===o&&(hide_cc_fields(),"new"===jQuery(this).val()?enable_stripe():(get_existing_token(jQuery(this).val()),elementsDiv.hide(),t.off("submit.stripe"),"000"!==amount&&t.on("submit.stripe",processExisting)))})}else if(s.length)"stripe"===jQuery('input[name="type"]:checked').data("gateway")&&(insertAndMountElementsDivBeforeInput(s.find("div.cc-details")),elementsDiv=jQuery("#stripeElements"),hide_cc_fields(),elementsDiv.hide().removeClass("hidden").show(),card.addEventListener("change",cardListener),cardExpiryElements.addEventListener("change",cardListener),cardCvcElements.addEventListener("change",cardListener),s.on("submit.stripe",addNewCardClientSide)),jQuery('input[name="type"]').on("ifChecked",function(){"stripe"===jQuery(this).data("gateway")?(insertAndMountElementsDivBeforeInput(s.find("div.cc-details")),elementsDiv=jQuery("#stripeElements"),hide_cc_fields(),elementsDiv.hide().removeClass("hidden").show(),s.off("submit.stripe"),s.on("submit.stripe",addNewCardClientSide),card.addEventListener("change",cardListener),cardExpiryElements.addEventListener("change",cardListener),cardCvcElements.addEventListener("change",cardListener)):(disable_stripe(),s.find(".cc-details").show())});else if(i.length)insertAndMountElementsDivBeforeInput(i.find("#billingAddressChoice")),i.find("#inputCardCvv").closest("div.form-group").remove(),i.off("submit",validateCreditCardInput),"new"===jQuery('input[name="ccinfo"]:checked').val()?enable_payment_stripe():(get_existing_token(jQuery('input[name="ccinfo"]:checked').val()),i.on("submit.stripe",processExisting)),jQuery('input[name="ccinfo"]').on("ifChecked",function(){"new"===jQuery(this).val()?enable_payment_stripe():(get_existing_token(jQuery(this).val()),jQuery("#stripeElements").hide(),i.off("submit.stripe"),i.on("submit.stripe",processExisting),card.hasRegisteredListener("change")&&card.removeEventListener("change",cardListener))}),enablePaymentRequestButton();else if(n.length)if(n.find("#cctype").closest("tr").hide().remove(),n.find("#inputCardNumber").closest("div").html('<div id="elementCardNumber" class="form-control"></div>'),n.find("#inputCardExpiry").closest("div").html('<div id="elementCardExpiry" class="form-control"></div>'),n.find("#cardcvv").closest("div").html('<div id="elementCardCvc" class="form-control"></div>'),card.mount("#elementCardNumber"),cardExpiryElements.mount("#elementCardExpiry"),cardCvcElements.mount("#elementCardCvc"),card.addEventListener("change",cardListener),cardExpiryElements.addEventListener("change",cardListener),cardCvcElements.addEventListener("change",cardListener),elementsDiv=jQuery("#elementCardNumber"),jQuery("#containerStorageInputControl")){var c=jQuery("#modalAjaxFooter"),m=c.find("#btnSave");m.removeAttr("name"),m.off(),m.on("click",validateChangeCard),modalInput=!0}else n.find("#btnSaveChanges").removeAttr("name"),n.on("submit.stripe",validateChangeCard)}function validateStripe(e){var t=jQuery('input[name="paymentmethod"]:checked'),s=elementsDiv.closest("form"),i=jQuery(".gateway-errors,.assisted-cc-input-feedback").first();return!(!t.length||"stripe"===t.val())||(e.preventDefault(),s.find('button[type="submit"],input[type="submit"]').prop("disabled",!0).addClass("disabled").find("span").toggleClass("hidden"),stripe.createPaymentMethod("card",card).then(function(e){if(e.error){var t=e.error.message;t&&(i.html(t),i.hasClass("hidden")&&i.removeClass("hidden").show(),scrollToGatewayInputError())}else WHMCS.http.jqClient.jsonPost({url:WHMCS.utils.getRouteUrl("/stripe/payment/intent"),data:s.serialize()+"&payment_method_id="+e.paymentMethod.id,success:function(e){e.success?stripeResponseHandler(e.token):e.two_factor?stripeResponseHandler(""):stripe.handleCardPayment(e.token,card).then(function(e){if(e.error){var t=e.error.message;t&&(i.html(t),i.hasClass("hidden")&&i.removeClass("hidden").show(),scrollToGatewayInputError())}else stripeResponseHandler(e.paymentIntent.id)})},warning:function(e){WHMCS.form.reloadCaptcha(),i.html(e),i.hasClass("hidden")&&i.removeClass("hidden").show(),scrollToGatewayInputError()},fail:function(e){i.html(e),i.hasClass("hidden")&&i.removeClass("hidden").show(),scrollToGatewayInputError()}})}),!1)}function processExisting(e){var t=elementsDiv.closest("form"),s=jQuery(".gateway-errors,.assisted-cc-input-feedback").first();t.find(".gateway-errors").html("").addClass("hidden"),e.preventDefault(),t.find('button[type="submit"],input[type="submit"]').prop("disabled",!0).addClass("disabled").find("span").toggleClass("hidden"),WHMCS.http.jqClient.jsonPost({url:WHMCS.utils.getRouteUrl("/stripe/payment/intent"),data:t.serialize()+"&payment_method_id="+existingToken,success:function(e){e.success?stripeResponseHandler(e.token):stripe.handleCardPayment(e.token).then(function(e){if(e.error){var t=e.error.message;t&&(s.html(t),s.hasClass("hidden")&&s.removeClass("hidden").show(),scrollToGatewayInputError())}else stripeResponseHandler(e.paymentIntent.id)})},warning:function(e){WHMCS.form.reloadCaptcha(),s.html(e),s.hasClass("hidden")&&s.removeClass("hidden").show(),scrollToGatewayInputError()},fail:function(e){s.html(e),s.hasClass("hidden")&&s.removeClass("hidden").show(),scrollToGatewayInputError()}})}function stripeResponseHandler(e){var t=elementsDiv.closest("form");t.find(".gateway-errors,.assisted-cc-input-feedback").html("").addClass("hidden"),t.append(jQuery('<input type="hidden" name="remoteStorageToken">').val(e)),t.find('button[type="submit"],input[type="submit"]').find("i.fas,i.far,i.fal,i.fab").removeAttr("class").addClass("fas fa-spinner fa-spin"),modalInput||elementsDiv.hide(),t.off("submit.stripe"),t.append('<input type="submit" id="hiddenSubmit" name="submit" value="Save Changes" style="display:none;">');var s=jQuery("#hiddenSubmit");if(modalInput){var i=jQuery("#modalAjaxFooter"),s=i.find("#btnSave");s.removeClass("disabled"),jQuery("#modalAjax .loader").fadeOut(),s.off("click",validateChangeCard),s.on("click",submitIdAjaxModalClickEvent)}s.click()}function hide_cc_fields(){var e=elementsDiv.closest("form"),t=jQuery("#newCardInfo,.cc-details,#existingCardInfo");t.is(":visible")&&t.slideUp("fast",function(){e.find("#cctype").removeAttr("name"),e.find("#inputCardCvvExisting").removeAttr("name"),e.find("#inputCardNumber").removeAttr("name"),e.find("#inputCardExpiry").removeAttr("name"),e.find("#inputCardCVV").removeAttr("name"),e.find("#inputCardCvvExisting").removeAttr("name")})}function enable_stripe(){var e=elementsDiv.closest("form"),t=jQuery("#inputDescriptionContainer");hide_cc_fields(),elementsDiv.hide().removeClass("hidden").show(),card.addEventListener("change",cardListener),cardExpiryElements.addEventListener("change",cardListener),cardCvcElements.addEventListener("change",cardListener),e.off("submit.stripe"),"000"===amount?e.on("submit.stripe",addNewCardClientSide):e.on("submit.stripe",validateStripe),t.addClass("col-md-offset-3")}function disable_stripe(){var e=elementsDiv.closest("form"),t=jQuery("#newCardInfo,.cc-details"),s=!0,i=jQuery("#inputDescriptionContainer");e.find("#inputCardCvvExisting").attr("name","cccvvexisting"),e.find("#inputCardNumber").attr("name","ccnumber"),e.find("#inputCardExpiry").attr("name","ccexpirydate"),e.find("#inputCardCVV").attr("name","cccvv"),e.find("#inputCardCvvExisting").attr("name","cccvvexisting"),e.find("#cctype").attr("name","cctype"),1===jQuery('input[name="paymentmethod"]:checked').data("remote-inputs")&&(s=!1),elementsDiv.hide("fast",function(){var e=jQuery('input[name="ccinfo"]:visible').first();"new"===e.val()?s&&t.show():e.click()}),e.off("submit.stripe"),card.hasRegisteredListener("change")&&card.removeEventListener("change",cardListener),cardExpiryElements.hasRegisteredListener("change")&&cardExpiryElements.removeEventListener("change",cardListener),cardCvcElements.hasRegisteredListener("change")&&cardCvcElements.removeEventListener("change",cardListener),i.removeClass("col-md-offset-3")}function enable_payment_stripe(){var e=elementsDiv.closest("form");e.find("#inputCardNumber").closest("div.form-group").remove(),e.find("#inputCardExpiry").closest("div.form-group").remove(),elementsDiv.hide().removeClass("hidden").show(),card.addEventListener("change",cardListener),cardExpiryElements.addEventListener("change",cardListener),cardCvcElements.addEventListener("change",cardListener),e.off("submit.stripe"),e.on("submit.stripe",validateStripe)}function enablePaymentRequestButton(){if(paymentRequestButtonEnabled){var e=(elementsDiv.closest("form"),stripe.paymentRequest({country:"US",currency:paymentRequestCurrency.toLowerCase(),total:{label:paymentRequestDescription,amount:paymentRequestAmountDue},requestPayerName:!0,requestPayerEmail:!0})),t=jQuery(".gateway-errors,.assisted-cc-input-feedback").first(),s=elements.create("paymentRequestButton",{paymentRequest:e});e.canMakePayment().then(function(e){e&&(e.applePay,0===jQuery("#paymentRequestButton").length&&elementsDiv.prepend('<div class="row"><div class="col-md-4 col-md-offset-4"><div id="paymentRequestButton"></div></div></div>'),s.mount("#paymentRequestButton"))}),e.on("paymentmethod",function(e){var s=e.paymentMethod.id,i=null,n=e,r=elementsDiv.closest("form");r.find(".gateway-errors,.assisted-cc-input-feedback").html("").addClass("hidden"),r.find('button[type="submit"],input[type="submit"]').addClass("disabled").prop("disabled",!0).find("i.fas,i.far,i.fal,i.fab").removeAttr("class").addClass("fas fa-spinner fa-spin"),WHMCS.http.jqClient.jsonPost({url:WHMCS.utils.getRouteUrl("/stripe/payment/intent"),data:r.serialize()+"&payment_method_id="+s,success:function(e){i=e.token,e.success?(n.complete("success"),stripeResponseHandler(e.token)):stripe.handleCardPayment(i).then(function(e){if(e.error){var s=e.error.message;s&&(t.html(s),t.hasClass("hidden")&&t.removeClass("hidden").show(),scrollToGatewayInputError())}else stripeResponseHandler(e.paymentIntent.id)})},warning:function(e){WHMCS.form.reloadCaptcha(),t.html(e),t.hasClass("hidden")&&t.removeClass("hidden").show(),scrollToGatewayInputError()},fail:function(e){t.html(e),t.hasClass("hidden")&&t.removeClass("hidden").show(),scrollToGatewayInputError()}})})}}function insertAndMountElementsDivAfterInput(e){if(elementsDiv=jQuery("#stripeElements"),!elementsDiv.length){e.after(stripe_cc_html(e));var t=jQuery("#stripeCvcWhere");t.length&&(jQuery("#cvvWhereLink").clone().appendTo(t),jQuery('[data-toggle="popover"]').popover({html:!0})),elementsDiv=jQuery("#stripeElements"),card.mount("#stripeCreditCard"),cardExpiryElements.mount("#stripeExpiryDate"),cardCvcElements.mount("#stripeCvc")}}function insertAndMountElementsDivBeforeInput(e){if(elementsDiv=jQuery("#stripeElements"),!elementsDiv.length){e.before(stripe_cc_html(e));var t=jQuery("#stripeCvcWhere");t.length&&(jQuery("#cvvWhereLink").clone().appendTo(t),jQuery('[data-toggle="popover"]').popover({html:!0})),elementsDiv=jQuery("#stripeElements"),card.mount("#stripeCreditCard"),cardExpiryElements.mount("#stripeExpiryDate"),cardCvcElements.mount("#stripeCvc")}}function stripe_cc_html(e){var t=e.closest("form")[0],s="";return"frmCheckout"===t.id?s='<div id="stripeElements" class="form-group hidden"><div class="stripe-cards-inputs col-md-8 col-md-offset-2"><div class="row"><div class="col-md-6"><label for="stripeCreditCard">'+lang.creditCardInput+'</label><div id="stripeCreditCard" class="form-control"></div><div id="stripeCardType"></div></div><div class="col-md-3"><label for="stripeExpiryDate">'+lang.creditCardExpiry+'</label><div id="stripeExpiryDate" class="form-control"></div></div><div class="col-md-3"><label for="stripeCvc">'+lang.creditCardCvc+'</label><div id="stripeCvc" class="form-control"></div></div></div></div></div><div class="clearfix"></div>':(elementsClass="",s='<div id="stripeElements" class="hidden"><div class="form-group cc-billing-address"><label for="stripeCreditCard" class="col-sm-4 control-label">'+lang.creditCardInput+'</label><div class="col-sm-7"><div id="stripeCreditCard" class="form-control" aria-describedby="cc-type"></div><div id="stripeCardType"></div></div><div class="col-sm-4"></div></div><div class="form-group cc-billing-address"><label for="stripeExpiryDate" class="col-sm-4 control-label">'+lang.creditCardExpiry+'</label><div class="col-sm-2"><div id="stripeExpiryDate" class="form-control"></div></div><div class="col-sm-6"></div></div><div class="form-group cc-billing-address"><label for="stripeCvc" class="col-sm-4 control-label">'+lang.creditCardCvc+'</label><div class="col-sm-2"><div id="stripeCvc" class="form-control"></div></div><div class="col-sm-4"><div id="stripeCvcWhere"></div></div></div></div></div><div class="clearfix"></div>'),s}function cardListener(e){var t=jQuery(".gateway-errors,.assisted-cc-input-feedback").first(),s="";"undefined"!=typeof e.error?(s=e.error.message,s&&(t.html(s),t.hasClass("hidden")&&t.removeClass("hidden").show(),scrollToGatewayInputError())):t.hide().addClass("hidden").html(""),"undefined"!=typeof e.brand}function addNewCardClientSide(e){var t=elementsDiv.closest("form"),s=jQuery(".gateway-errors,.assisted-cc-input-feedback").first();e.preventDefault(),t.find('button[type="submit"],input[type="submit"]').prop("disabled",!0).addClass("disabled").find("span").toggleClass("hidden"),WHMCS.http.jqClient.jsonPost({url:WHMCS.utils.getRouteUrl("/stripe/setup/intent"),data:t.serialize(),success:function(e){e.success&&stripe.handleCardSetup(e.setup_intent,card).then(function(e){e.error?(s.html(e.error.message),s.hasClass("hidden")&&s.removeClass("hidden").show(),scrollToGatewayInputError()):stripeResponseHandler(e.setupIntent.id)})},warning:function(e){s.html(e),s.hasClass("hidden")&&s.removeClass("hidden").show(),scrollToGatewayInputError()},fail:function(e){s.html(e),s.hasClass("hidden")&&s.removeClass("hidden").show(),scrollToGatewayInputError()}})}function validateChangeCard(e){var t=elementsDiv.closest("form"),s=jQuery(".gateway-errors,.assisted-cc-input-feedback").first();return e.preventDefault(),t.find('button[type="submit"],input[type="submit"]').prop("disabled",!0).addClass("disabled").find("span").toggleClass("hidden"),stripe.createPaymentMethod("card",card).then(function(e){if(e.error){var i=e.error.message;i&&(s.html(i),s.hasClass("hidden")&&s.removeClass("hidden").show(),scrollToGatewayInputError())}else{if(modalInput){var n=jQuery("#btnSave");n.addClass("disabled"),jQuery("#modalAjax .loader").show()}if("undefined"!=typeof WHMCS.utils)var r=WHMCS.utils.getRouteUrl("/stripe/payment/add");else var r=WHMCS.adminUtils.getAdminRouteUrl("/stripe/payment/admin/add");WHMCS.http.jqClient.jsonPost({url:r,data:t.serialize()+"&payment_method_id="+e.paymentMethod.id,success:function(e){e.success&&stripeResponseHandler(e.token)},warning:function(e){s.html(e),s.hasClass("hidden")&&s.removeClass("hidden").show(),scrollToGatewayInputError()},fail:function(e){s.html(e),s.hasClass("hidden")&&s.removeClass("hidden").show(),scrollToGatewayInputError()},always:function(){modalInput&&(n.removeClass("disabled"),jQuery("#modalAjax .loader").fadeOut())}})}}),!1}function get_existing_token(e){if("undefined"==typeof e){var t=jQuery('input[name="ccinfo"]:visible:first');if(t.iCheck("check"),e=t.val(),"new"===e)return}var s=jQuery(".gateway-errors,.assisted-cc-input-feedback").first(),i=s.closest("form");i.find('button[type="submit"],input[type="submit"]').prop("disabled",!0).addClass("disabled").find("span").toggleClass("hidden"),WHMCS.http.jqClient.jsonPost({url:WHMCS.utils.getRouteUrl("/payment/stripe/token/get"),data:"paymethod_id="+e+"&token="+csrfToken,success:function(e){existingToken=e.token,i.find('button[type="submit"],input[type="submit"]').prop("disabled",!1).removeClass("disabled").find("span").toggleClass("hidden")},warning:function(e){s.html(e),s.hasClass("hidden")&&s.removeClass("hidden").show(),scrollToGatewayInputError(),reset_input_to_new()},fail:function(e){s.html(e),s.hasClass("hidden")&&s.removeClass("hidden").show(),scrollToGatewayInputError(),reset_input_to_new()}})}function reset_input_to_new(){jQuery('input[name="ccinfo"][value="new"]').iCheck("check"),jQuery("#existingCardInfo").is(":visible")&&jQuery("#existingCardInfo").hide(),setTimeout(function(){jQuery(".gateway-errors,.assisted-cc-input-feedback").hide().addClass("hidden")},4e3)}var elementsDiv=null,modalInput=!1;